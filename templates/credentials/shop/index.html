{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Certification{% endblock %}

{% block meta_description %}
    The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
    Ubuntu Desktop, and Ubuntu Server topics.
{% endblock meta_description %}

{% block content %}
    <div id="react-root">
        <div class="row u-align--center">
            <section class="p-strip">
                <div class="row u-align--center">
                    <div class="col-12 u-no-margin--bottom p-card">
                        <i class="p-icon--spinner u-animation--spin"></i> Loading&hellip;
                    </div>
                </div>
            </section>
        </div>
    </div>

<form onsubmit="handleSubmit(); return false">
  <div class="p-strip product-selector">
    <div class="row">
      <h2>Select an exam to purchase</h2>
    </div>
    <div class="row u-hide--small">
      {% for exam in exams %}
      <div class="col-4">
        <div class="p-card--radio--column 
          {% if loop.index0 == exam_index %}
            is-selected
          {% endif %}"
        >
          <label class="p-radio">
            <input class="p-radio__input" type="radio" 
              {% if exam.price is not defined %}
                disabled
              {% endif %}
            />
            <span class="p-radio__label">
              <label class="inner-label p-radio" label="{{ exam.name }}">
                <input class="p-radio__input" name="exam-radio" type="radio" value={{ loop.index0 }} 
                  {% if loop.index0 == exam_index %}
                    checked
                  {% endif %}
                  {% if exam.price is not defined %}
                    disabled
                  {% endif %}
                />
                <span class="p-radio__label">
                  {{ exam.name }}
                </span>
              </label>
              <hr/>
              <p style="padding-left: 1rem; padding-right: 1rem;">
                {{ exam.metadata[0].value }}
              </p>
              <hr/>
              <h5 id="exam-price" class="u-align--right" style="padding-right: 1rem;">
                {% if exam.price is not defined %}
                Coming Soon!
                {% else %}
                <span class="exam-price" id="exam-price-{{ exam.id }}">Price: {{ exam.price.currency }} {{ exam.price.value }}</span>
                {% endif %}
              </h5>
            </span>
          </label>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Smaller cards for minimised window -->
    {% for exam in exams %}
    <div class="col-12 u-hide u-show--small">
      <div 
        class="p-card--radio--column
          {% if loop.index0 == exam_index %}
            is-selected
          {% endif %}" 
        style="margin-left: 1rem; margin-right: 1rem;"
        >
        <label class="p-radio--inline" label="{{ exam.name }}">
          <input class="p-radio__input" type="radio" name="exam-radio--small" value={{ loop.index0 }} 
            {% if loop.index0 == exam_index %}
              checked
            {% endif %}
            {% if exam.price is not defined %}
              disabled
            {% endif %}
            />
          <span class="p-radio__label">
            {{ exam.name }}
          </span>
        </label>
        <span>
          <p style="padding-left: 1rem; padding-right: 1rem;">
            {{ exam.metadata[0].value }}
          </p>
        </span>
        <span>
          <h5 id="exam-price" class="u-align--right" style="padding-right: 1rem;">
            {% if exam.price is not defined %}
              Coming Soon!
            {% else %}
            <span class="exam-price" id="exam-price-{{ exam.id }}">Price: {{ exam.price.currency }} {{ exam.price.value }}</span>
            {% endif %}
          </h5>
        </span>
      </div>
    </div>
    {% endfor %}
  </div>

  <section id="order-cart" class="p-strip--light is-shallow p-shop-cart p-shop-cart--cue">
    <div class="row u-sv3">
      <div class="col-6 p-text--small-caps">
        Your Order
      </div>        
    </div>
    <div class="row">
      <div class="col-6" style="display: flex;">
        <p class="order-name p-heading--2" style="margin-block: auto;">
          {{ exams[exam_index].name }}
        </p>
      </div>
      <div class="col-3 col-small-2" style="display: flex;">
        <p id="exam-price" class="p-heading--2" style="margin-block: auto;">
          <span id="total-price" class="exam-price">Price: {{ exams[exam_index].price.currency }} {{ exams[exam_index].price.value }}</span>
        </p>
      </div>
      <div class="col-3 col-small-2 u-align--right" style="display: flex;">
        <!-- Make it a form submit button -->
        <button type="submit" class="p-button--positive" style="margin-block: auto;">
          Buy Now
        </button>
      </div>
    </div>
  </section>
</form>

<script src="{{ versioned_static('js/dist/credEnterprisePurchasing.js') }}" type="module" defer></script>
<script>
  window.stripePublishableKey = "{{ get_stripe_publishable_key }}";

  function currencyFormatter(currency, value) {
    const formatter = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: currency,
    });
    return formatter.format(value/100);
  };

  function updateCurrency() {
    const prices = document.querySelectorAll("#exam-price");
    for (var i = 0; i < prices.length; i++) {
        const priceElement = prices[i];
        const price = priceElement.getElementsByClassName("exam-price")[0];

        if (price) {
          const priceList = price.innerHTML.split(" ");
          const formattedPrice = currencyFormatter(priceList[1], parseInt(priceList[2]));          
          if (price.id == "total-price") {
            price.innerHTML = formattedPrice;
          } else {
            price.innerHTML = 'Price: ' + formattedPrice;
          }
        }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
		updateCurrency();
	});

  document.getElementsByName("exam-radio").forEach(function(e) {
    e.addEventListener("click", function() {
      updateOrder(e.value);
    });
  });

  document.getElementsByName("exam-radio--small").forEach(function(e) {
    e.addEventListener("click", function() {
      updateOrder(e.value);
    });
  });

  function updateOrder(exam_index) {
    // Update order cart
    const order = document.querySelectorAll("#order-cart");
    const orderName = order[0].getElementsByClassName("order-name")[0];
    const orderPrice = order[0].getElementsByClassName("exam-price")[0];
    const exams = {{ exams | tojson }};    
    orderName.innerHTML = exams[exam_index].name;
    orderPrice.innerHTML = currencyFormatter(exams[exam_index].price.currency, exams[exam_index].price.value);

    // Update selected card
    const card = document.querySelectorAll(".p-card--radio--column");
    for (var i = 0; i < card.length; i++) {
      if (i == exam_index || i == exam_index/2 ) {
        card[i].classList.add("is-selected");
      } else {
        card[i].classList.remove("is-selected");
      }
    }
  };

  const handleSubmit = () => {
    event.preventDefault();
    const index = document.querySelector('input[name="exam-radio"]:checked').value;
    const exams = {{ exams | tojson }};

    localStorage.setItem(
      "shop-checkout-data",
      JSON.stringify({
        product: exams[index],
        quantity: 1,
        action: "purchase",
      })
    );
    location.href = "/account/checkout";
  };
  
</script>
{% endblock %}
