{% extends "credentials/base_cred.html" %}

{% block title %}Canonical Certification{% endblock %}

{% block meta_description %}
  The Canonical Ubuntu Essentials exams certify knowledge and verify skills in general Linux,
  Ubuntu Desktop, and Ubuntu Server topics.
{% endblock meta_description %}

{% block content %}
  <form onsubmit="handleSubmit(); return false">
    <div class="p-strip product-selector">
      <div class="row">
        <h2>Select an exam to purchase</h2>
      </div>
      <div class="row u-hide--small">
        {% for exam in exams %}
          <div class="col-4">
            <div id="price-card-{{ loop.index0 }}" class="p-card--radio--column">
              <label class="p-radio">
                <input id="price-radio-{{ loop.index0 }}"
                       class="p-radio__input"
                       type="radio" />
                <span class="p-radio__label">
                  <label class="inner-label p-radio" label="{{ exam.name }}">
                    <input id="price-radio-inner-{{ loop.index0 }}" class="p-radio__input" name="exam-radio" type="radio" value={{ loop.index0 }} />
                    <span class="p-radio__label">{{ exam.name }}</span>
                  </label>
                  <hr />
                  <p style="padding-left: 1rem; padding-right: 1rem;">{{ exam.metadata[0].value }}</p>
                  <hr />
                  <h5 id="exam-price-{{ loop.index0 }}"
                      class="u-align--right"
                      style="padding-right: 1rem">
                    <span class="exam-price" id="exam-price-{{ loop.index0 }}"></span>
                  </h5>
                </span>
              </label>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Smaller cards for minimised window -->
      {% for exam in exams %}
        <div class="col-12 u-hide u-show--small">
          <div id="price-card-{{ loop.index0 }}"
               class="p-card--radio--column"
               style="margin-left: 1rem;
                      margin-right: 1rem">
            <label class="p-radio--inline" label="{{ exam.name }}">
              <input id="price-radio-{{ loop.index0 }}" class="p-radio__input" type="radio" name="exam-radio--small" value={{ loop.index0 }} />
              <span class="p-radio__label">{{ exam.name }}</span>
            </label>
            <span>
              <p style="padding-left: 1rem; padding-right: 1rem;">{{ exam.metadata[0].value }}</p>
            </span>
            <span>
              <h5 id="exam-price-{{ loop.index0 }}"
                  class="u-align--right"
                  style="padding-right: 1rem">
                <span class="exam-price" id="exam-price-{{ loop.index0 }}"></span>
              </h5>
            </span>
          </div>
        </div>
      {% endfor %}
    </div>

    <section id="order-cart"
             class="p-strip--light is-shallow p-shop-cart p-shop-cart--cue">
      <div class="row u-sv3">
        <div class="col-6 p-text--small-caps">Your Order</div>
      </div>
      <div class="row">
        <div class="col-6" style="display: flex;">
          <p id="selected-product-name"
             class="order-name p-heading--2"
             style="margin-block: auto"></p>
        </div>
        <div class="col-3 col-small-2" style="display: flex;">
          <p id="exam-price" class="p-heading--2" style="margin-block: auto;">
            <span id="total-price" class="exam-price"></span>
          </p>
        </div>
        <div class="col-3 col-small-2 u-align--right" style="display: flex;">
          <button type="submit" class="p-button--positive" style="margin-block: auto;">Buy Now</button>
        </div>
      </div>
    </section>
  </form>

  <script>
    window.stripePublishableKey = "{{ get_stripe_publishable_key }}";
    const exams = JSON.parse('{{ exams | tojson }}');
    let examIndex = JSON.parse("{{ exam_index }}")

    function currencyFormatter({
      currency,
      value
    }) {
      const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: currency,
      });
      return formatter.format(value / 100);
    };

    const getExamFinalPrice = (examIndex = 0) => {
      const exam = exams[examIndex];
      const examOriginalPrice = exam?.metadata?.find((e) => e.key === 'originalPrice' && !!e.value);
      const examDiscountedPrice = exam?.metadata?.find((e) => e.key === 'discountedPrice' && !!e.value);

      if (!examDiscountedPrice && !examOriginalPrice) return {
        price: null,
        type: null,
        examOriginalPrice: null,
        examDiscountedPrice: null,
      };

      return {
        price: examDiscountedPrice || examOriginalPrice,
        type: examDiscountedPrice ? 'discountedPrice' : 'originalPrice',
        examOriginalPrice,
        examDiscountedPrice,
      }
    }

    const updateOrderTotal = (examIndex = 0) => {
      // if user enables radio button
      if (examIndex > 0) {
        setInitialData();
        return;
      }
      const exam = exams[examIndex];
      const selectedProduct = document.getElementById('selected-product-name');
      const totalPrice = document.getElementById('total-price');
      selectedProduct.innerText = exam.displayName;
      const {
        price
      } = getExamFinalPrice(examIndex);
      totalPrice.innerText = `${currencyFormatter(price)}`;
    }

    const setInitialData = (examIndex = 0) => {
      // select the active card
      const card = document.getElementById(`price-card-${examIndex}`);
      card.classList.add('is-selected');
      updateOrderTotal(examIndex);

      // select/disable cards and add prices
      exams.forEach((exam, idx) => {
        const radioInput = document.querySelectorAll(`#price-radio-${idx}`);
        const radioInputInner = document.querySelectorAll(`#price-radio-inner-${idx}`);
        const examPriceH5 = document.querySelectorAll(`h5#exam-price-${idx}`)
        const examPriceSpan = document.querySelectorAll(`span#exam-price-${idx}`);
        const {
          price,
          type,
          examOriginalPrice,
          examDiscountedPrice
        } = getExamFinalPrice(idx);
        radioInput.forEach((r) => r.disabled = !price);
        radioInputInner.forEach((r) => r.disabled = !price);

        if (idx === examIndex) {
          radioInputInner.forEach((r) => r.checked = "checked");
        }
        if (!price) {
          examPriceH5.forEach((r) => r.innerHTML = 'Coming Soon');
          // examPriceSpan.forEach((r) => r.hidden = true);
        } else {
          if (type === 'discountedPrice') {
            examPriceSpan.forEach((r) => r.innerHTML = `Price: <s>${currencyFormatter(examOriginalPrice)}</s> ${currencyFormatter(examDiscountedPrice)}`);
          } else {
            examPriceSpan.forEach((r) => r.innerText = `Price: ${currencyFormatter(examOriginalPrice)}`);
          }

        }
      })
    }

    document.addEventListener("DOMContentLoaded", () => {
      setInitialData();
    });

    document.getElementsByName("exam-radio").forEach(function(e) {
      e.addEventListener("click", function() {
        updateOrderTotal(e.value);
      });
    });

    document.getElementsByName("exam-radio--small").forEach(function(e) {
      e.addEventListener("click", function() {
        updateOrderTotal(e.value);
      });
    });

    const handleSubmit = () => {
      event.preventDefault();
      const index = document.querySelector('input[name="exam-radio"]:checked').value;

      localStorage.setItem(
        "shop-checkout-data",
        JSON.stringify({
          product: exams[index],
          quantity: 1,
          action: "purchase",
        })
      );
      location.href = "/account/checkout";
    };
  </script>
{% endblock %}
